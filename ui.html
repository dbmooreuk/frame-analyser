<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Frame Analyzer</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: #333333;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    .title {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }
    
    .description {
      font-size: 11px;
      color: #666666;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .instructions {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
    }
    
    .instructions-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .instructions-list {
      margin: 0;
      padding-left: 16px;
      color: #666666;
    }
    
    .instructions-list li {
      margin-bottom: 4px;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .button {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      color: #374151;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .button:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .button.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #ffffff;
    }
    
    .button.primary:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      display: none;
    }
    
    .status.success {
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      color: #166534;
    }
    
    .status.error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }

    .status.warning {
      background: #fffbeb;
      border: 1px solid #fde68a;
      color: #d97706;
    }
    
    .feature-list {
      /* background: #f0f9ff; */
      /* border: 1px solid #bae6fd; */
      border-radius: 6px;
      /* padding: 12px; */
      margin-bottom: 20px;
    }
    
    .feature-list-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #000000;
    }
    
    .feature-list ul {
      margin: 0;
      padding-left: 16px;
      color: #000000;
    }
    
    .feature-list li {
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
      display: none;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-details {
      margin-top: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      font-size: 10px;
      color: #666666;
      display: none;
      max-height: 120px;
      overflow-y: auto;
    }

    .progress-item {
      margin-bottom: 2px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    }

    .progress-item.current {
      color: #2563eb;
      font-weight: 500;
    }

    .tips {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
    }

    .tips-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #92400e;
    }

    .tips ul {
      margin: 0;
      padding-left: 16px;
      color: #b45309;
    }

    .tips li {
      margin-bottom: 4px;
    }

    .version {
      text-align: center;
      font-size: 10px;
      color: #9ca3af;
      margin-top: 16px;
    }

    /* Frame History Styles */
    .frame-history {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .frame-history h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }

    .frame-history h3:hover {
      color: #0d99ff;
    }

    .collapse-icon {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .frame-history.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .frame-history.collapsed .frame-content {
      display: none;
    }

    .frame-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    /* Responsive adjustments for resizable UI */
    @media (min-height: 700px) {
      .frame-list {
        max-height: 300px; /* More space when window is taller */
      }
    }

    @media (min-height: 800px) {
      .frame-list {
        max-height: 400px; /* Even more space for very tall windows */
      }
    }

    @media (max-width: 300px) {
      .frame-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .frame-actions {
        margin-left: 0;
        margin-top: 8px;
      }

      .bulk-actions {
        flex-direction: column;
      }
    }

    .frame-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 12px;
    }

    .frame-info {
      flex: 1;
      min-width: 0;
    }

    .frame-name {
      font-weight: 500;
      color: #333;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .frame-details {
      color: #666;
      font-size: 11px;
      margin-top: 2px;
    }

    .frame-actions {
      margin-left: 8px;
    }

    .re-analyze-btn {
      background: #0d99ff;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .re-analyze-btn:hover {
      background: #0b7ce6;
    }

    .bulk-actions {
      display: flex;
      gap: 8px;
    }

    .bulk-action-btn {
      flex: 1;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bulk-action-btn:hover {
      background: #e0e0e0;
      border-color: #ccc;
    }

    .bulk-action-btn.primary {
      background: #0d99ff;
      color: white;
      border-color: #0d99ff;
    }

    .bulk-action-btn.primary:hover {
      background: #0b7ce6;
      border-color: #0b7ce6;
    }

    .empty-state {
      text-align: center;
      color: #666;
      font-size: 12px;
      padding: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">Frame Analyzer</div>
    <div class="description">
      Analyze one or more selected frames to extract components, fonts, and colors used in your HMI screen designs.
    </div>
  </div>
  
  <div class="feature-list">
    <div class="feature-list-title">What this plugin extracts:</div>
    <ul>
      <li>Components and instances used</li>
      <li>Font variations and typography</li>
      <li>Color palette and color styles</li>
      <li>Organized analysis frame output</li>
    </ul>
  </div>
  
  <div class="instructions">
    <div class="instructions-title">How to use:</div>
    <ol class="instructions-list">
      <li>Select one or more frames on your canvas</li>
      <li>Click "Analyze Frames" below</li>
      <li>A new frame will be created with the analysis results</li>
      <li>The analysis frame will be positioned next to your selected frame</li>
    </ol>
  </div>

  <!-- <div class="tips">
    <div class="tips-title">ðŸ’¡ Tips for best results:</div>
    <ul>
      <li>Works best with organized designs</li>
      <li>Use named color and text styles for better organization</li>
      <li>Re-analyzing a frame will update the existing analysis frame</li>
    </ul>
  </div> -->
  
  <div class="button-group">
    <button class="button" id="cancel-btn">Cancel</button>
    <button class="button primary" id="analyze-btn">Analyze Frames</button>
  </div>

  <div class="progress-bar" id="progress-bar">
    <div class="progress-bar-fill" id="progress-fill"></div>
  </div>

  <div class="progress-details" id="progress-details"></div>

  <div class="status" id="status"></div>

  <!-- Frame History Section -->
  <div class="frame-history" id="frame-history">
    <h3 id="frame-history-toggle">
      Previously Analyzed Frames
      <span class="collapse-icon">â–¼</span>
    </h3>
    <div class="frame-content">
      <div class="frame-list" id="frame-list">
        <div class="empty-state" id="empty-state">
          No frames analyzed yet. Analyze a frame to see it listed here.
        </div>
      </div>
      <div class="bulk-actions">
        <button class="bulk-action-btn primary" id="re-analyze-all-btn" disabled>Re-analyze All</button>
        <button class="bulk-action-btn" id="clear-list-btn" disabled>Clear List</button>
      </div>
    </div>
  </div>

  <div class="version">Frame Analyzer v1.0 - Design Analysis Tool</div>
  
  <script>
    // Get UI elements
    const analyzeBtn = document.getElementById('analyze-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const progressDetails = document.getElementById('progress-details');
    const frameList = document.getElementById('frame-list');
    const emptyState = document.getElementById('empty-state');
    const reAnalyzeAllBtn = document.getElementById('re-analyze-all-btn');
    const clearListBtn = document.getElementById('clear-list-btn');
    const frameHistory = document.getElementById('frame-history');
    const frameHistoryToggle = document.getElementById('frame-history-toggle');
    
    // Handle analyze button click
    analyzeBtn.addEventListener('click', () => {
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'Analyzing...';
      hideStatus();
      showProgress();

      // Send message to plugin code
      parent.postMessage({
        pluginMessage: { type: 'analyze-frame' }
      }, '*');
    });
    
    // Handle cancel button click
    cancelBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'cancel' }
      }, '*');
    });

    // Handle bulk action buttons
    reAnalyzeAllBtn.addEventListener('click', () => {
      // Update button state immediately on click
      reAnalyzeAllBtn.textContent = 'Analyzing...';
      reAnalyzeAllBtn.disabled = true;

      parent.postMessage({ pluginMessage: { type: 'reAnalyzeAll' } }, '*');
    });

    clearListBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the analyzed frames list?')) {
        parent.postMessage({ pluginMessage: { type: 'clearFramesList' } }, '*');
      }
    });

    // Handle frame history collapse/expand
    frameHistoryToggle.addEventListener('click', () => {
      frameHistory.classList.toggle('collapsed');
    });
    
    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'success') {
        showStatus(msg.message, 'success');
        resetAnalyzeButton();
        hideProgress();

        // Auto-dismiss success message if specified
        if (msg.autoDismiss && msg.dismissAfter) {
          setTimeout(() => {
            hideStatus();
          }, msg.dismissAfter);
        }
      } else if (msg.type === 'error') {
        showStatus(msg.message, 'error');
        resetAnalyzeButton();
        hideProgress();
      } else if (msg.type === 'progress') {
        analyzeBtn.textContent = msg.message;
        updateProgress();
        if (msg.details) {
          addProgressDetail(msg.details);
        }
      } else if (msg.type === 'warning') {
        showStatus(msg.message, 'warning');
      } else if (msg.type === 'framesListUpdated') {
        updateFramesList(msg.framesList);
      } else if (msg.type === 'updateButtonState') {
        updateButtonState(msg);
      }
    };

    // Frame list management
    function updateFramesList(framesList) {
      if (!framesList || framesList.length === 0) {
        frameList.innerHTML = '<div class="empty-state">No frames analyzed yet. Analyze a frame to see it listed here.</div>';
        reAnalyzeAllBtn.disabled = true;
        clearListBtn.disabled = true;
        return;
      }

      // Sort frames by last analyzed date (newest first)
      framesList.sort((a, b) => new Date(b.lastAnalyzed) - new Date(a.lastAnalyzed));

      frameList.innerHTML = framesList.map(frame => {
        const date = new Date(frame.lastAnalyzed);
        const timeAgo = getTimeAgo(date);

        return `
          <div class="frame-item">
            <div class="frame-info">
              <div class="frame-name" title="${frame.name}">${frame.name}</div>
              <div class="frame-details">${frame.elementCount} elements â€¢ ${timeAgo}</div>
            </div>
            <div class="frame-actions">
              <button class="re-analyze-btn" onclick="reAnalyzeFrame('${frame.id}')">Re-analyze</button>
            </div>
          </div>
        `;
      }).join('');

      reAnalyzeAllBtn.disabled = false;
      clearListBtn.disabled = false;
    }

    function reAnalyzeFrame(frameId) {
      // Update button state immediately on click
      const button = document.querySelector(`[onclick="reAnalyzeFrame('${frameId}')"]`);
      if (button) {
        button.textContent = 'Analyzing...';
        button.disabled = true;
      }

      parent.postMessage({ pluginMessage: { type: 'reAnalyzeFrame', frameId: frameId } }, '*');
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    // Handle button state updates from plugin
    function updateButtonState(msg) {
      if (msg.frameId) {
        // Update specific frame re-analyze button
        const button = document.querySelector(`[onclick="reAnalyzeFrame('${msg.frameId}')"]`);
        if (button) {
          if (msg.state === 'analyzing') {
            button.textContent = 'Analyzing...';
            button.disabled = true;
          } else {
            // Reset to normal state (complete or error)
            button.textContent = 'Re-analyze';
            button.disabled = false;
          }
        }
      } else if (msg.buttonType === 'analyze') {
        // Update main analyze button
        if (msg.state === 'analyzing') {
          analyzeBtn.textContent = 'Analyzing...';
          analyzeBtn.disabled = true;
        } else {
          // Reset to normal state (complete or error)
          analyzeBtn.textContent = 'Analyze Frames';
          analyzeBtn.disabled = false;
        }
      } else if (msg.buttonType === 'reAnalyzeAll') {
        // Update re-analyze all button
        if (msg.state === 'analyzing') {
          reAnalyzeAllBtn.textContent = 'Analyzing...';
          reAnalyzeAllBtn.disabled = true;
        } else {
          // Reset to normal state (complete or error)
          reAnalyzeAllBtn.textContent = 'Re-analyze All';
          reAnalyzeAllBtn.disabled = false;
        }
      }
    }
    
    // Show status message
    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }
    
    // Hide status message
    function hideStatus() {
      status.style.display = 'none';
    }
    
    // Reset analyze button
    function resetAnalyzeButton() {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = 'Analyze Frames';
    }

    // Show progress bar
    function showProgress() {
      progressBar.style.display = 'block';
      progressDetails.style.display = 'block';
      progressFill.style.width = '0%';
      progressDetails.innerHTML = '';
      progressValue = 0;
    }

    // Hide progress bar
    function hideProgress() {
      progressBar.style.display = 'none';
      progressDetails.style.display = 'none';
      progressFill.style.width = '0%';
      progressDetails.innerHTML = '';
    }

    // Update progress bar (simple animation)
    let progressValue = 0;
    function updateProgress() {
      progressValue = Math.min(progressValue + 15, 90);
      progressFill.style.width = progressValue + '%';
    }

    // Add detailed progress information
    function addProgressDetail(detail) {
      const item = document.createElement('div');
      item.className = 'progress-item current';
      item.textContent = detail;

      // Remove 'current' class from previous items
      const previousItems = progressDetails.querySelectorAll('.progress-item.current');
      previousItems.forEach(prevItem => {
        prevItem.classList.remove('current');
      });

      progressDetails.appendChild(item);

      // Auto-scroll to bottom
      progressDetails.scrollTop = progressDetails.scrollHeight;

      // Keep only last 10 items to prevent overflow
      const items = progressDetails.querySelectorAll('.progress-item');
      if (items.length > 10) {
        items[0].remove();
      }
    }

    // Initialize
    hideProgress();
    hideStatus();

    // Load frames list on startup
    parent.postMessage({ pluginMessage: { type: 'getFramesList' } }, '*');
  </script>
</body>
</html>
